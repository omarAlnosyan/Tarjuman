flowchart TD
    START([User Types Verse<br/>عفت الديار محلها فمقامها]) --> FRONT[Frontend<br/>Next.js]
    
    FRONT --> |POST /search| API[FastAPI Backend]
    
    API --> GUARD{Guardrails Check}
    GUARD -->|Invalid| REJECT[400 Error<br/>Not Poetry Query]
    GUARD -->|Valid| HYBRID[Hybrid Search]
    
    HYBRID --> EXACT{Exact Match?}
    EXACT -->|Found| RESULT1[Result: Score 1.0]
    EXACT -->|Not Found| BM25_SEARCH[BM25 Search]
    
    BM25_SEARCH --> BM25_RESULT[Top 5 Results<br/>Score: 0.85]
    BM25_SEARCH --> FAISS_SEARCH[FAISS Search]
    
    FAISS_SEARCH --> FAISS_RESULT[Top 5 Results<br/>Score: 0.78]
    
    BM25_RESULT --> MERGE[Merge & Rank<br/>0.7 × BM25 + 0.3 × FAISS]
    FAISS_RESULT --> MERGE
    RESULT1 --> MERGE
    
    MERGE --> FINAL[Final Result<br/>Score: 0.829]
    
    FINAL --> LLM_CHECK{LLM Available?}
    LLM_CHECK -->|Yes| LLM[Enhance Explanation<br/>Llama 3.3 70B]
    LLM_CHECK -->|No| ORIGINAL[Original Explanation]
    
    LLM --> ENHANCED[Enhanced Explanation]
    ORIGINAL --> ENHANCED
    
    ENHANCED --> RESPONSE[API Response<br/>JSON]
    RESPONSE --> DISPLAY[Display Result<br/>Verse Card]
    DISPLAY --> END([User Sees Result])
    
    style START fill:#e3f2fd
    style FRONT fill:#e1f5ff
    style API fill:#fff4e1
    style HYBRID fill:#f3e5f5
    style LLM fill:#e8f5e9
    style DISPLAY fill:#e1f5ff
    style END fill:#e3f2fd
    style REJECT fill:#ffebee
